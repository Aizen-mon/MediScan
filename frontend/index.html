<!DOCTYPE html>
<html>
<head>
  <title>Pharma Verification System</title>
</head>
<body>
  <h2>✅ Medicine Verification (No Blockchain)</h2>

  <!-- LOGIN -->
  <div id="loginBox">
    <h3>Login</h3>
    <input id="email" placeholder="Email"><br><br>
    <input id="password" type="password" placeholder="Password"><br><br>
    <button onclick="login()">Login</button>
    <p id="loginMsg"></p>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" style="display:none;">
    <h3>Welcome <span id="userName"></span> (<span id="userRole"></span>)</h3>
    <button onclick="logout()">Logout</button>

    <hr>

    <!-- Manufacturer Register Medicine -->
    <div id="registerBox" style="display:none;">
      <h3>Register Medicine (Manufacturer Only)</h3>
      <input id="batchID" placeholder="Batch ID"><br><br>
      <input id="medName" placeholder="Medicine Name"><br><br>
      <input id="manufacturer" placeholder="Manufacturer"><br><br>
      <input id="mfgDate" placeholder="MFG Date (YYYY-MM-DD)"><br><br>
      <input id="expDate" placeholder="EXP Date (YYYY-MM-DD)"><br><br>
      <input id="totalUnits" placeholder="Total Units in Batch"><br><br>
      <button onclick="registerMedicine()">Register</button>
      <p id="regMsg"></p>
      <hr>
    </div>

    <!-- Transfer Ownership -->
    <div>
      <h3>Transfer Ownership</h3>
      <input id="transferBatch" placeholder="Batch ID"><br><br>
      <input id="newOwnerEmail" placeholder="New Owner Email"><br><br>
      <input id="newOwnerRole" placeholder="New Owner Role (DISTRIBUTOR/PHARMACY/CUSTOMER)"><br><br>
      <button onclick="transferOwnership()">Transfer</button>
      <p id="transferMsg"></p>
      <hr>
    </div>

    <!-- Customer Purchase -->
    <div id="purchaseBox" style="display:none;">
      <h3>Customer Purchase</h3>
      <input id="purchaseBatch" placeholder="Batch ID"><br><br>
      <input id="purchaseUnits" placeholder="Units to Buy (default 1)"><br><br>
      <button onclick="purchaseMedicine()">Purchase</button>
      <p id="purchaseMsg"></p>
      <hr>
    </div>

    <!-- QR Generator -->
    <div>
      <h3>Generate QR</h3>
      <input id="qrBatch" placeholder="Batch ID"><br><br>
      <button onclick="generateQR()">Generate QR</button><br><br>
      <img id="qrImg" width="200"/>
      <hr>
    </div>

    <!-- Verify -->
    <div>
      <h3>Verify Medicine</h3>
      <input id="verifyBatch" placeholder="Batch ID"><br><br>
      <button onclick="verify()">Verify</button>
      <p id="verifyResult"></p>
      <pre id="historyBox"></pre>
    </div>
  </div>

<script>
  const API = "http://localhost:5000"; // change to hosted URL if needed
  let token = "";
  let role = "";

  async function login(){
    const res = await fetch(`${API}/auth/login`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ email: email.value, password: password.value })
    });

    const data = await res.json();
    if(data.token){
      token = data.token;
      role = data.role;

      loginBox.style.display="none";
      dashboard.style.display="block";

      userName.innerText = data.name;
      userRole.innerText = data.role;

      // show register only for manufacturer
      if(data.role === "MANUFACTURER"){
        registerBox.style.display="block";
      }

      // show purchase only for customer
      if(data.role === "CUSTOMER"){
        purchaseBox.style.display="block";
      }

    }else{
      loginMsg.innerText = data.error;
    }
  }

  function logout(){
    token="";
    role="";
    dashboard.style.display="none";
    registerBox.style.display="none";
    purchaseBox.style.display="none";
    loginBox.style.display="block";
  }

  async function registerMedicine(){
    const res = await fetch(`${API}/medicine/register`,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":`Bearer ${token}`
      },
      body: JSON.stringify({
        batchID: batchID.value,
        name: medName.value,
        manufacturer: manufacturer.value,
        mfgDate: mfgDate.value,
        expDate: expDate.value,
        totalUnits: totalUnits.value
      })
    });

    const data = await res.json();
    regMsg.innerText = data.message || data.error;
  }

  async function transferOwnership(){
    const res = await fetch(`${API}/medicine/transfer/${transferBatch.value}`,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":`Bearer ${token}`
      },
      body: JSON.stringify({
        newOwnerEmail: newOwnerEmail.value,
        newOwnerRole: newOwnerRole.value
      })
    });

    const data = await res.json();
    transferMsg.innerText = data.message || data.error;
  }

  async function purchaseMedicine(){
    const units = purchaseUnits.value || 1;

    const res = await fetch(`${API}/medicine/purchase/${purchaseBatch.value}`,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":`Bearer ${token}`
      },
      body: JSON.stringify({
        unitsToBuy: units
      })
    });

    const data = await res.json();
    purchaseMsg.innerText = data.message || data.error;
  }

  async function generateQR(){
    const res = await fetch(`${API}/medicine/qrcode/${qrBatch.value}`,{
      headers:{ "Authorization":`Bearer ${token}` }
    });

    const data = await res.json();
    if(data.qr){
      qrImg.src = data.qr;
    }else{
      alert(data.error);
    }
  }

  async function verify(){
    const resQR = await fetch(`${API}/medicine/qrcode/${verifyBatch.value}`,{
      headers:{ "Authorization":`Bearer ${token}` }
    });
    const qrData = await resQR.json();

    if(!qrData.qrURL){
      verifyResult.innerText = "❌ Invalid batch";
      return;
    }

    const res = await fetch(qrData.qrURL);
    const data = await res.json();

    verifyResult.innerText = data.result;

    if(data.ownerHistory){
      historyBox.innerText = JSON.stringify(data.ownerHistory, null, 2);
    }
  }
</script>

</body>
</html>
